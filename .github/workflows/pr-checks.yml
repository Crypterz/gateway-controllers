name: PR Checks

on:
  pull_request_target:
    branches:
      - main
      - '*.*.0'
    paths:
      - 'policies/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  pr-checks:
    name: Go PR Validation
    runs-on: ubuntu-latest
    timeout-minutes: 25

    env:
      RUN_FORMAT: true
      RUN_IMPORTS: true
      RUN_VET: true
      RUN_STATICCHECK: true
      RUN_GOVULNCHECK: true
      RUN_GOSEC: true
      RUN_BUILD: true
      RUN_TESTS: true
      RUN_POLICY_VALIDATION: true

      PASS: "âœ…"
      FAIL: "âŒ"

    steps:
      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      # ------------------------------------------------------------
      # Setup Go
      # ------------------------------------------------------------
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.3"
          cache: false

      # ------------------------------------------------------------
      # Install Tools
      # ------------------------------------------------------------
      - name: Install Go tools
        run: |
          go install golang.org/x/tools/cmd/goimports@latest
          go install honnef.co/go/tools/cmd/staticcheck@latest
          go install golang.org/x/vuln/cmd/govulncheck@latest
          go install github.com/securego/gosec/v2/cmd/gosec@latest

      # ------------------------------------------------------------
      # Detect Changed Policies
      # ------------------------------------------------------------
      - name: Detect changed policies
        id: policies
        run: |
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.event.pull_request.head.sha }}"

          POLICIES=$(git diff --name-only "$BASE" "$HEAD" | \
            grep '^policies/' | \
            while read -r f; do
              d=$(dirname "$f")
              while [[ "$d" != "policies" && "$d" != "." ]]; do
                [[ -f "$d/go.mod" ]] && echo "${d#policies/}" && break
                d=$(dirname "$d")
              done
            done | sort -u)

          if [[ -z "$POLICIES" ]]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "policies<<EOF" >> $GITHUB_OUTPUT
            echo "$POLICIES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      # ------------------------------------------------------------
      # Init Result Flags
      # ------------------------------------------------------------
      - name: Init result flags
        run: |
          echo "FORMAT_STATUS=$PASS" >> $GITHUB_ENV
          echo "IMPORT_STATUS=$PASS" >> $GITHUB_ENV
          echo "VET_STATUS=$PASS" >> $GITHUB_ENV
          echo "STATICCHECK_STATUS=$PASS" >> $GITHUB_ENV
          echo "GOVULN_STATUS=$PASS" >> $GITHUB_ENV
          echo "GOSEC_STATUS=$PASS" >> $GITHUB_ENV
          echo "BUILD_STATUS=$PASS" >> $GITHUB_ENV
          echo "TEST_STATUS=$PASS" >> $GITHUB_ENV
          echo "POLICY_STATUS=$PASS" >> $GITHUB_ENV

      # ------------------------------------------------------------
      # Quality Checks
      # ------------------------------------------------------------
      - name: Formatting, Vet & Staticcheck
        if: steps.policies.outputs.has_changes == 'true'
        run: |
          ROOT=$(pwd)

          while read -r policy; do
            cd "$ROOT/policies/$policy" || continue

            [[ "$RUN_FORMAT" == "true" ]] && \
              gofmt -l . | grep -q . && FORMAT_STATUS=$FAIL

            [[ "$RUN_IMPORTS" == "true" ]] && \
              goimports -l . | grep -q . && IMPORT_STATUS=$FAIL

            [[ "$RUN_VET" == "true" ]] && \
              ! go vet ./... >> "$ROOT/errors.log" 2>&1 && VET_STATUS=$FAIL

            [[ "$RUN_STATICCHECK" == "true" ]] && \
              ! staticcheck ./... >> "$ROOT/errors.log" 2>&1 && STATICCHECK_STATUS=$FAIL

            cd "$ROOT"
          done <<< "${{ steps.policies.outputs.policies }}"

          echo "FORMAT_STATUS=${FORMAT_STATUS:-$PASS}" >> $GITHUB_ENV
          echo "IMPORT_STATUS=${IMPORT_STATUS:-$PASS}" >> $GITHUB_ENV
          echo "VET_STATUS=${VET_STATUS:-$PASS}" >> $GITHUB_ENV
          echo "STATICCHECK_STATUS=${STATICCHECK_STATUS:-$PASS}" >> $GITHUB_ENV

      # ------------------------------------------------------------
      # Security Checks
      # ------------------------------------------------------------
      - name: govulncheck & gosec
        if: steps.policies.outputs.has_changes == 'true'
        run: |
          ROOT=$(pwd)

          while read -r policy; do
            cd "$ROOT/policies/$policy" || continue

            [[ "$RUN_GOVULNCHECK" == "true" ]] && \
              ! govulncheck ./... >> "$ROOT/errors.log" 2>&1 && GOVULN_STATUS=$FAIL

            [[ "$RUN_GOSEC" == "true" ]] && \
              ! gosec -severity=medium ./... >> "$ROOT/errors.log" 2>&1 && GOSEC_STATUS=$FAIL

            cd "$ROOT"
          done <<< "${{ steps.policies.outputs.policies }}"

          echo "GOVULN_STATUS=${GOVULN_STATUS:-$PASS}" >> $GITHUB_ENV
          echo "GOSEC_STATUS=${GOSEC_STATUS:-$PASS}" >> $GITHUB_ENV

      # ------------------------------------------------------------
      # Build & Test
      # ------------------------------------------------------------
      - name: Build & Test
        if: steps.policies.outputs.has_changes == 'true'
        run: |
          ROOT=$(pwd)

          while read -r policy; do
            cd "$ROOT/policies/$policy" || continue

            [[ "$RUN_BUILD" == "true" ]] && \
              ! go build ./... >> "$ROOT/errors.log" 2>&1 && BUILD_STATUS=$FAIL

            [[ "$RUN_TESTS" == "true" ]] && \
              ! go test -race ./... >> "$ROOT/errors.log" 2>&1 && TEST_STATUS=$FAIL

            cd "$ROOT"
          done <<< "${{ steps.policies.outputs.policies }}"

          echo "BUILD_STATUS=${BUILD_STATUS:-$PASS}" >> $GITHUB_ENV
          echo "TEST_STATUS=${TEST_STATUS:-$PASS}" >> $GITHUB_ENV

      # ------------------------------------------------------------
      # Policy Structure Validation
      # ------------------------------------------------------------
      - name: Policy validation
        if: steps.policies.outputs.has_changes == 'true'
        run: |
          while read -r policy; do
            for f in go.mod policy-definition.yaml; do
              [[ ! -f "policies/$policy/$f" ]] && POLICY_STATUS=$FAIL
            done
          done <<< "${{ steps.policies.outputs.policies }}"

          echo "POLICY_STATUS=${POLICY_STATUS:-$PASS}" >> $GITHUB_ENV

      # ------------------------------------------------------------
      # PR Summary
      # ------------------------------------------------------------
      - name: PR Summary
        if: always()
        run: |
          {
            echo "## ðŸ” PR Validation Summary"
            echo ""
            echo "| Check | Status |"
            echo "|------|--------|"
            echo "| Formatting | $FORMAT_STATUS |"
            echo "| Imports | $IMPORT_STATUS |"
            echo "| go vet | $VET_STATUS |"
            echo "| staticcheck | $STATICCHECK_STATUS |"
            echo "| govulncheck | $GOVULN_STATUS |"
            echo "| gosec | $GOSEC_STATUS |"
            echo "| Build | $BUILD_STATUS |"
            echo "| Tests | $TEST_STATUS |"
            echo "| Policy structure | $POLICY_STATUS |"
          } >> $GITHUB_STEP_SUMMARY

      # ------------------------------------------------------------
      # Final Failure Gate
      # ------------------------------------------------------------
      - name: Fail if any check failed
        if: steps.policies.outputs.has_changes == 'true'
        run: |
          if grep -q "$FAIL" <<< "
            $FORMAT_STATUS
            $IMPORT_STATUS
            $VET_STATUS
            $STATICCHECK_STATUS
            $GOVULN_STATUS
            $GOSEC_STATUS
            $BUILD_STATUS
            $TEST_STATUS
            $POLICY_STATUS
          "; then
            cat errors.log || true
            exit 1
          fi
