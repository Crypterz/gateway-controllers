name: PR Checks

on:
  pull_request:
    branches: [main, master]
    paths:
      - 'policies/**'
      - '.github/workflows/**'
  pull_request_target:
    branches: [main, master]
    paths:
      - 'policies/**'
      - '.github/workflows/**'

permissions:
  contents: read
  pull-requests: read

jobs:
  pr-checks:
    name: Build, Test & Lint
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------------------------------------
      # Setup Go
      # ------------------------------------------------------------
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"
          cache: true

      # ------------------------------------------------------------
      # Install additional tools
      # ------------------------------------------------------------
      - name: Install formatting tools
        run: |
          go install golang.org/x/tools/cmd/goimports@latest
          go install honnef.co/go/tools/cmd/staticcheck@latest
          go install golang.org/x/vuln/cmd/govulncheck@latest

      # ------------------------------------------------------------
      # Find changed policies
      # ------------------------------------------------------------
      - name: Find changed policies
        id: changed-policies
        run: |
          # Get list of changed files
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          else
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          fi

          # Find changed policy directories
          CHANGED_POLICIES=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | \
            grep '^policies/' | \
            cut -d/ -f2 | \
            sort -u || true)

          if [[ -z "$CHANGED_POLICIES" ]]; then
            echo "No policy changes detected"
            echo "policies=" >> "$GITHUB_OUTPUT"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "Changed policies: $CHANGED_POLICIES"
            echo "policies<<EOF" >> "$GITHUB_OUTPUT"
            echo "$CHANGED_POLICIES" >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      # ------------------------------------------------------------
      # Run all checks
      # ------------------------------------------------------------
      - name: Run all checks
        if: steps.changed-policies.outputs.has_changes == 'true'
        run: |
          echo "## ðŸ” PR Checks Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Changed policies:**" >> $GITHUB_STEP_SUMMARY
          
          while IFS= read -r policy; do
            [[ -z "$policy" ]] && continue
            echo "- \`$policy\`" >> $GITHUB_STEP_SUMMARY
          done <<< "${{ steps.changed-policies.outputs.policies }}"
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Checks performed:**" >> $GITHUB_STEP_SUMMARY
          
          FAILED=false
          
          # Go formatting
          echo "Checking Go formatting..." >> $GITHUB_STEP_SUMMARY
          UNFORMATTED=$(find policies/ -name "*.go" -exec gofmt -l {} +)
          if [[ -n "$UNFORMATTED" ]]; then
            echo "- âŒ Go formatting errors:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$UNFORMATTED" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "Run \`go fmt ./...\` to fix." >> $GITHUB_STEP_SUMMARY
            FAILED=true
          else
            echo "- âœ… Go formatting" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Go imports
          echo "Checking Go imports..." >> $GITHUB_STEP_SUMMARY
          UNFORMATTED=$(find policies/ -name "*.go" -exec goimports -l {} +)
          if [[ -n "$UNFORMATTED" ]]; then
            echo "- âŒ Import formatting errors:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$UNFORMATTED" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "Run \`goimports -w .\` to fix." >> $GITHUB_STEP_SUMMARY
            FAILED=true
          else
            echo "- âœ… Import formatting" >> $GITHUB_STEP_SUMMARY
          fi
          
          # go vet
          echo "Running go vet..." >> $GITHUB_STEP_SUMMARY
          VET_ERRORS=""
          while IFS= read -r policy; do
            [[ -z "$policy" ]] && continue
            VET_OUTPUT=$(cd "policies/$policy" && go vet ./... 2>&1)
            if [[ $? -ne 0 ]]; then
              VET_ERRORS="${VET_ERRORS}Failed for $policy\n$VET_OUTPUT\n"
            fi
          done <<< "${{ steps.changed-policies.outputs.policies }}"
          if [[ -n "$VET_ERRORS" ]]; then
            echo "- âŒ Go vet errors:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo -e "$VET_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          else
            echo "- âœ… Go vet" >> $GITHUB_STEP_SUMMARY
          fi
          
          # staticcheck
          echo "Running staticcheck..." >> $GITHUB_STEP_SUMMARY
          STATIC_ERRORS=""
          while IFS= read -r policy; do
            [[ -z "$policy" ]] && continue
            STATIC_OUTPUT=$(cd "policies/$policy" && staticcheck ./... 2>&1)
            if [[ $? -ne 0 ]]; then
              STATIC_ERRORS="${STATIC_ERRORS}Failed for $policy\n$STATIC_OUTPUT\n"
            fi
          done <<< "${{ steps.changed-policies.outputs.policies }}"
          if [[ -n "$STATIC_ERRORS" ]]; then
            echo "- âŒ Static analysis errors:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo -e "$STATIC_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          else
            echo "- âœ… Static analysis (staticcheck)" >> $GITHUB_STEP_SUMMARY
          fi
          
          # govulncheck
          echo "Running govulncheck..." >> $GITHUB_STEP_SUMMARY
          export PATH="$PATH:$(go env GOPATH)/bin"
          VULN_ERRORS=""
          while IFS= read -r policy; do
            [[ -z "$policy" ]] && continue
            VULN_OUTPUT=$(cd "policies/$policy" && govulncheck ./... 2>&1)
            if [[ $? -ne 0 ]]; then
              VULN_ERRORS="${VULN_ERRORS}Failed for $policy\n$VULN_OUTPUT\n"
            fi
          done <<< "${{ steps.changed-policies.outputs.policies }}"
          if [[ -n "$VULN_ERRORS" ]]; then
            echo "- âŒ Vulnerability check errors:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo -e "$VULN_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          else
            echo "- âœ… Vulnerability check (govulncheck)" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Build
          echo "Building policies..." >> $GITHUB_STEP_SUMMARY
          BUILD_ERRORS=""
          while IFS= read -r policy; do
            [[ -z "$policy" ]] && continue
            BUILD_OUTPUT=$(cd "policies/$policy" && go build -v ./... 2>&1)
            if [[ $? -ne 0 ]]; then
              BUILD_ERRORS="${BUILD_ERRORS}Failed for $policy\n$BUILD_OUTPUT\n"
            fi
          done <<< "${{ steps.changed-policies.outputs.policies }}"
          if [[ -n "$BUILD_ERRORS" ]]; then
            echo "- âŒ Build errors:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo -e "$BUILD_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          else
            echo "- âœ… Build verification" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Tests
          echo "Testing policies..." >> $GITHUB_STEP_SUMMARY
          TEST_ERRORS=""
          while IFS= read -r policy; do
            [[ -z "$policy" ]] && continue
            TEST_OUTPUT=$(cd "policies/$policy" && go test -v -race -timeout=5m ./... 2>&1)
            if [[ $? -ne 0 ]]; then
              TEST_ERRORS="${TEST_ERRORS}Failed for $policy\n$TEST_OUTPUT\n"
            fi
          done <<< "${{ steps.changed-policies.outputs.policies }}"
          if [[ -n "$TEST_ERRORS" ]]; then
            echo "- âŒ Test errors:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo -e "$TEST_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          else
            echo "- âœ… Test execution (with race detection)" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Policy structure validation
          echo "Validating policy structure..." >> $GITHUB_STEP_SUMMARY
          STRUCT_ERRORS=""
          while IFS= read -r policy; do
            [[ -z "$policy" ]] && continue
            POLICY_DIR="policies/$policy"
            # Check required files
            for file in go.mod policy-definition.yaml; do
              if [[ ! -f "$POLICY_DIR/$file" ]]; then
                STRUCT_ERRORS="${STRUCT_ERRORS}Missing $file in $POLICY_DIR\n"
              fi
            done
            # Check .go files
            if ! find "$POLICY_DIR" -name "*.go" -type f | grep -q .; then
              STRUCT_ERRORS="${STRUCT_ERRORS}No .go files in $POLICY_DIR\n"
            fi
            # Validate module path
            if [[ -f "$POLICY_DIR/go.mod" ]]; then
              MODULE_PATH=$(grep '^module ' "$POLICY_DIR/go.mod" | awk '{print $2}')
              EXPECTED="github.com/DakshithaS/gateway-controllers/policies/$policy"
              if [[ "$MODULE_PATH" != "$EXPECTED"* ]]; then
                STRUCT_ERRORS="${STRUCT_ERRORS}Invalid module path in $POLICY_DIR/go.mod: $MODULE_PATH (expected $EXPECTED)\n"
              fi
            fi
          done <<< "${{ steps.changed-policies.outputs.policies }}"
          if [[ -n "$STRUCT_ERRORS" ]]; then
            echo "- âŒ Policy structure errors:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo -e "$STRUCT_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            FAILED=true
          else
            echo "- âœ… Policy structure validation" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "$FAILED" == "true" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Some checks failed. Please fix the issues above.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      # ------------------------------------------------------------
      # Summary
      # ------------------------------------------------------------
      - name: Generate summary
        if: steps.changed-policies.outputs.has_changes == 'false'
        run: |
          echo "## ðŸ” PR Checks Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No policy changes detected in this PR." >> $GITHUB_STEP_SUMMARY